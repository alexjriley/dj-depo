{% extends 'base.html' %}
{% load static %}

{% block hero %}
  <!-- Full width hero carousel -->
  <div id="heroCarousel" class="carousel slide" data-bs-ride="carousel">
    <div class="carousel-inner">
      <div class="carousel-item active">
        <img src="{% static 'images/pexels-gigxels-7709006.jpg' %}" class="d-block w-100 hero-img" alt="A turntable DJ playing a record">
      </div>
      <div class="carousel-item">
        <img src="{% static 'images/pexels-kei-scampa-1201427-16113965.jpg' %}" class="d-block w-100 hero-img" alt="A rave in an industrial warehouse with a balcony">
      </div>
      <div class="carousel-item">
        <img src="{% static 'images/pexels-odin-reyna-383507-8673525.jpg' %}" class="d-block w-100 hero-img" alt="A woman DJing at a festival">
      </div>
    </div>
    <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Previous</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Next</span>
    </button>
  </div>

  <!-- Intro container under the hero -->
  <div id="intro" class="container mt-4">
    <div class="row d-flex align-items-center justify-content-between flex-lg-row flex-column">
      <div class="col-lg-8 col-md-8 text-center text-lg-start">
        <h1 class="display-4 mb-0">Find your next favourite mix</h1>
        <p class="lead mb-0">Browse, listen, and share DJ mixes from across the community.</p>
      </div>
      <div class="col-lg-4 col-md-4 text-center mt-3 mt-lg-0 align-self-center">
        <a href="{% url 'upload_audio' %}" class="btn btn-lg btn-dark">Upload a mix</a>
      </div>
    </div>
  </div>
{% endblock %}

{% block content %}
<section id="discover" class="container mt-4">
  <h2 class="display-5 text-center">Discover</h2>

  {% if posts %}
  <div class="row g-4">
    {% for post in posts %}
    <div class="col-12 mix-col">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title">{{ post.title }}</h5>
          <p class="card-text text-muted">by {{ post.user.username }}</p>
        </div>
        {% if post.audio_file and post.audio_file.url %}
        <div class="p-3">
          <!-- Unique container with data attributes -->
          <div id="waveform-{{ post.id }}"
               class="waveform"
               data-post-id="{{ post.id }}"
               data-audio-url="{{ post.audio_file.url }}"></div>
        </div>
        <div class="p-3 text-center mix-controls d-flex justify-content-center align-items-center gap-2">
          <button class="btn btn-success btn-sm playPause" data-post-id="{{ post.id }}" aria-pressed="false" disabled>
            <!-- Inline SVG icon toggled by JS (play / pause) -->
            <svg class="icon-play" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M8 5v14l11-7z" />
            </svg>
            <svg class="icon-pause d-none" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
            </svg>
            <span class="visually-hidden">Play</span>
          </button>
          <div class="mix-time" id="mix-time-{{ post.id }}">&nbsp;0:00 / 0:00</div>
        </div>
        {% endif %}


        <!-- Delete post -- only visible to the post owner -->
        
      {% if user.is_authenticated and user == post.user %}
      <div class="p-3 text-center">
        <!-- Delete Button triggers modal -->
         <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal-{{ post.id }}"> <i class="bi bi-trash"></i> Delete
        </button>
      </div>
      {% endif %}

      <!-- Bootstrap Modal -->
       <div class="modal fade" id="deleteModal-{{ post.id }}" tabindex="-1" aria-labelledby="deleteModalLabel-{{ post.id }}" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
      
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel-{{ post.id }}">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        Are you sure you want to delete <strong>{{ post.title }}</strong>?
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form method="POST" action="{% url 'post-delete' post.id %}" class="d-inline">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">Yes, Delete</button>
        </form>
      </div>

    </div>
  </div>
</div>

      </div>
    </div>
    {% endfor %}
  </div>

  {% if user.is_authenticated %}
  <div class="row mt-3">
    <div class="col-12 col-lg-auto">
      <a class="btn btn-dark w-100 w-lg-auto" href="{% url 'upload_audio' %}">
        <span class="d-none d-lg-inline">Upload&nbsp;new&nbsp;audio</span>
        <span class="d-inline d-lg-none">Upload new audio</span>
      </a>
    </div>
  </div>
  {% else %}
  <p class="mt-3">
    <a class="btn btn-dark w-lg-auto" href="{% url 'login' %}">Log in</a> to upload audio.
  </p>
  {% endif %}
  {% else %}
  <p>No mixes uploaded yet.</p>
  {% endif %}
</section>

<!-- Uploading instructions section -->
  <section id="how-to">
    <h2 class="display-6">Share yours</h2>
    <div class="container">
      <div class="row">
        <div class="col-lg-6 col-md-12">
      <p class="lead">
        To use the platform:
      </p>
      <p class="lead"> <i class="fa-solid fa-user-plus"></i> Create an account
      <br> <i class="fa-solid fa-cloud-arrow-up"></i> Upload your audio file
      <br> <i class="fa-solid fa-globe"></i> Give it a name + share </p>
      </div>
    <div class="col-lg-6 mt-4 container-fluid">
      <img src="/static/images/pexels-aleksandr-neplokhov-486399-1238941.jpg" alt="" class="card" width="600" height="auto">
    </div>
    </div>
  </section>

{% endblock %}
{% block extra_scripts %}
<!-- Page-specific JS (after Wavesurfer is loaded in base.html) -->
<script src="{% static 'mixes/js/wavesurfer-init.js' %}" defer></script>
{% endblock %}
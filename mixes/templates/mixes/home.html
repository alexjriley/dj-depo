{% extends 'base.html' %}
{% load static %}

{% block hero %}
  <!-- Full width hero carousel -->
    <div id="heroCarousel" class="carousel slide" data-bs-ride="carousel">
    <div class="carousel-inner">
      <div class="carousel-item active">
        <img src="{% static 'images/pexels-gigxels-7709006.webp' %}" class="d-block w-100 hero-img" alt="A turntable DJ playing a record">
      </div>
      <div class="carousel-item">
        <img src="{% static 'images/pexels-kei-scampa-1201427-16113965.webp' %}" class="d-block w-100 hero-img" alt="A rave in an industrial warehouse with a balcony">
      </div>
      <div class="carousel-item">
        <img src="{% static 'images/pexels-odin-reyna-383507-8673525.webp' %}" class="d-block w-100 hero-img" alt="A woman DJing at a festival">
      </div>
    </div>
    <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Previous</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Next</span>
    </button>
  </div>

  <!-- Intro container under the hero -->
  <section class="container py-4 py-md-6 px-3">    
    <div id="intro">
    <div class="row d-flex align-items-center justify-content-between flex-lg-row flex-column">
      <div class="col-lg-8 col-md-8 text-center text-lg-start">
        <h1 class="display-4 mt-3 mb-0">Find your next favourite mix</h1>
        <p class="lead mb-0">Browse, listen, and share DJ mixes from across the community.</p>
      </div>
      <div class="col-lg-4 col-md-4 text-center mt-3 mt-lg-0 align-self-center">
        <a href="{% url 'upload_audio' %}" class="btn btn-lg btn-dark">Upload a mix</a>
      </div>
    </div>
  </div>
  {% endblock %}
  </section>


{% block content %}
<section id="discover" class="container py-4 py-md-5 px-3">
  <h2 class="display-5 text-center">Discover</h2>
  {% if posts %}
  <div class="row g-3 g-md-4">
    {% for post in posts %}
    <div class="col-12 mix-col">
      <div class="card h-100">
        <div class="card-body">
          <h3 class="card-title">{{ post.title }}</h3>
          <p class="card-text text-muted">by {{ post.user.username }}</p>
          <p class="card-text">{{ post.description }}</p>
        </div>
        {% if post.audio_file and post.audio_file.url %}
        <div class="p-3">
          <!-- Unique container with data attributes -->
          <div id="waveform-{{ post.id }}"
               class="waveform"
               data-post-id="{{ post.id }}"
               data-audio-url="{{ post.audio_file.url }}"></div>
        </div>
        <div class="p-3 text-center mix-controls d-flex justify-content-center align-items-center gap-2">
          <button class="btn btn-success btn-sm playPause" data-post-id="{{ post.id }}" aria-pressed="false" aria-label="Play">
            <!-- Inline SVG icon toggled by JS (play / pause) -->
            <svg class="icon-play" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M8 5v14l11-7z" />
            </svg>
            <svg class="icon-pause d-none" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
            </svg>
            <span class="visually-hidden">Play</span>
          </button>
          <div class="mix-time" id="mix-time-{{ post.id }}">&nbsp;0:00 / 0:00</div>
        </div>
        {% endif %}

        {% if user.is_authenticated and user == post.user %}
        <div class="p-3 text-center d-flex justify-content-center align-items-center gap-2">
          <form method="POST" action="{% url 'edit_audio_post' post.id %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-primary btn-sm">Edit</button>
          </form>
          <form method="GET" action="{% url 'edit_audio_post' post.id %}">
            <button type="submit" class="btn btn-danger btn-sm">Delete</button>
          </form>
        </div>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>

  {% if user.is_authenticated %}
  <div class="row mt-3 mb-3">
    <div class="text-center mt-0 mt-lg-0 align-self-center">
      <a class="btn btn-dark w-lg-auto" href="{% url 'upload_audio' %}">
        <span class="d-none d-lg-inline">Upload&nbsp;new&nbsp;audio</span>
        <span class="d-inline d-lg-none">Upload new audio</span>
      </a>
    </div>
  </div>
  {% else %}
  <p class="mt-3">
    <a class="btn btn-dark w-lg-auto" href="{% url 'login' %}">Log in</a> to upload audio.
  </p>
  {% endif %}
  {% else %}
  <p>No mixes uploaded yet.</p>
  {% endif %}
</section>

<!-- Uploading instructions section -->
  <section id="how-to" class="container py-4 py-md-5 px-3">
  <h4 class="display-6 text-center mb-4">Share yours</h4>
  <div class="row justify-content-center">
    <div class="col-12 col-md-6 col-lg-4">
      <div class="p-3 border rounded bg-light text-center">
        <p class="lead mb-3">To use the platform:</p>
        <ul class="list-unstyled lead">
          <li class="mb-2"><i class="fa-solid fa-user-plus me-2"></i>Create an account</li>
          <li class="mb-2"><i class="fa-solid fa-cloud-arrow-up me-2"></i>Upload your audio file</li>
          <li><i class="fa-solid fa-globe me-2"></i>Give it a name + share</li>
        </ul>
      </div>
    </div>
    <div class="col-12 col-md-6 col-lg-6 mt-4 mt-md-0">
      <img src="/static/images/pexels-aleksandr-neplokhov-486399-1238941.webp" alt="DJ equipment and vinyl records on a table" class="img-fluid rounded shadow h-100 w-lg-auto">
    </div>
  </div>
</section>

{% endblock %}
{% block extra_scripts %}
<!-- Page-specific JS (after Wavesurfer is loaded in base.html) -->
<script src="{% static 'mixes/js/wavesurfer-init.js' %}" defer></script>
{% endblock %}